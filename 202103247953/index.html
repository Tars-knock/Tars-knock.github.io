<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/batman.png"><link rel="icon" href="/img/batman.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="description" content="关于java虚拟机的内存管理策略以及算法梳理"><meta name="author" content="Tars-knock"><meta name="keywords" content="技术笔记 日常随笔"><title>java虚拟机内存管理总结 - Tars Blog</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"www.tars-knock.cn",root:"/",version:"1.8.10",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:"000c8623e418a244bb21d401c84cbfc3",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"zldqPvhiQPhi7OHlqIQKsssf-gzGzoHsz",app_key:"seqt5G6b8y8z6p0zo03uR31L",server_url:"https://zldqpvhi.lc-cn-n1-shared.com"}}}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><header style="height:45vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Tars blog</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 文章</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档 </a><a class="dropdown-item" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类 </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></div></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/sfln.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="java虚拟机内存管理总结"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-03-24 20:04" pubdate>2021年3月24日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.3k 字 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">java虚拟机内存管理总结</h1><p class="note note-info">本文最后更新于：4 个月前</p><div class="markdown-body"><h2 id="java内存区域分配"><a href="#java内存区域分配" class="headerlink" title="java内存区域分配"></a>java内存区域分配</h2><p><img src="image-20210324204216125.png" srcset="/img/loading.gif" lazyload alt="一张图 简洁明了"></p><ul><li><p>线程私有数据区</p><ul><li><p>程序计数器</p><blockquote><p>可以看成是当前线程所执行的字节码的行号指示器<em>唯一一个不会产生任何OOM情况的区域</em></p></blockquote></li><li><p>java虚拟机栈</p><ul><li>生命周期与线程相同</li><li>储存单位为<strong>栈帧</strong>；每个方法执行时创建一个，储存<strong>局部变量表</strong>，<strong>操作数栈</strong>，<strong>动态链接</strong>，<strong>方法出口</strong>，等信息；</li><li>方法开始执行时对应的栈帧入栈，方法执行结束对应的栈帧出栈</li></ul></li><li><p>本地方法栈</p><blockquote><p>与虚拟机栈类似，只是服务于虚拟机使用到的本地方法，对于具体的实现方法没有要求，HotSpot等虚拟机甚至将其与虚拟机栈合二为一</p></blockquote></li></ul></li><li><p>线程共享数据区</p><ul><li><p>java堆</p><blockquote><p><em>几乎</em>所有对象实例以及数组都要在堆上分配</p><p>JIT编译器、标量替换技术等可能会使对象分配至其他区域</p></blockquote></li><li><p>方法区</p><blockquote><p>储存运行时常量池、<strong>已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据</strong></p></blockquote></li></ul></li></ul><h2 id="java垃圾收集"><a href="#java垃圾收集" class="headerlink" title="java垃圾收集"></a>java垃圾收集</h2><h3 id="垃圾的判定"><a href="#垃圾的判定" class="headerlink" title="垃圾的判定"></a>垃圾的判定</h3><ul><li><p>引用计数法</p><blockquote><p>维护一个引用计数器，对象每被引用一次计数器就+1；</p><p>缺点是无法识别循环引用，难以做到线程同步；java并未采用</p></blockquote></li><li><p>可达性分析算法</p><blockquote><p>以“GC Roots”为起点进行搜索，如果对象不可达便认为可回收<br>可作为GC Roots 的对象：</p><ul><li>虚拟机栈（本地方法栈）栈帧局部变量表中引用的对象</li><li>方法区中静态属性引用的对象</li><li>方法区中常量引用的对象</li></ul></blockquote></li></ul><h3 id="垃圾收集算法"><a href="#垃圾收集算法" class="headerlink" title="垃圾收集算法"></a>垃圾收集算法</h3><h4 id="标记-清除算法"><a href="#标记-清除算法" class="headerlink" title="标记-清除算法"></a>标记-清除算法</h4><p>首先使用可达性算法将所有可回收的对象进行标记，之后进行回收</p><p>缺点：效率低、产生空间碎片</p><h4 id="复制算法"><a href="#复制算法" class="headerlink" title="复制算法"></a>复制算法</h4><p>将内存分为两个区域实际使用时在一个区域中分配对象；当这个区域满后再将所有可用对象复制进另一个区域，袁曲宇清空。</p><p>实际实现中往往是将内存分为一个较大的Eden空间和两个较小的Survivor空间，只使用Eden和一块Survivor，回收时一次性将两块空间中的活对象复制进空闲的Survivor。<em>HotSpot默认Eden与Survivor是8:1</em>；当Survivor空间不足时还需要依赖其他内存（老年代）来进行分配担保。</p><p>缺点：对象存活率较高时效率变低、需要担保</p><h4 id="标记-整理算法"><a href="#标记-整理算法" class="headerlink" title="标记-整理算法"></a>标记-整理算法</h4><p>标记过程与标记-清除算法相同，但是后续步骤不是直接对可回收对象进行清理，而是让所有存活对象向一端移动，然后直接清理边界以外的内存。</p><h4 id="分代收集"><a href="#分代收集" class="headerlink" title="分代收集"></a>分代收集</h4><p>虚拟机将java堆分为新生代与老年代，目的是便于针对不同的区域使用不同的收集算法；新生代中的对象存活率较低，所以可以使复制算法；老年代中对象存活率高且没有担保，所以要用标记-清除或者标记-整理算法。</p><h3 id="内存分配与回收策略"><a href="#内存分配与回收策略" class="headerlink" title="内存分配与回收策略"></a>内存分配与回收策略</h3><ul><li><p>对象优先在Eden分配</p></li><li><p>大对象直接进入老年代</p></li><li><p>长期存活的对象进入老年代</p></li><li><p>动态对象年龄判定</p><blockquote><p>在Survivor空间中相同年龄所有对象大小的总和大于Survivor空间的一半,年龄大于或等于该年龄的对象就可以直接进入老年代,无须等到MaxTenuringThreshold中要求的年龄</p></blockquote></li><li><p>空间分配担保</p><blockquote><p>在发生Minor GC之前,虚拟机会先检查老年代最大可用的连续空间是否大于新生代所有对象总空间,如果这个条件成立,那么Minor GC可以确保是安全的。如果不成立,则虚拟机会查看HandlePromotionFailure设置值是否允许担保失败。如果允许,那么会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小,如果大于,将尝试着进行一次Minor GC,尽管这次Minor GC是有风险的;如果小于,或者HandlePromotionFailure设置不允许冒险,那这时也要改为进行一次Full GC</p></blockquote></li></ul><h3 id="具体的垃圾收集器"><a href="#具体的垃圾收集器" class="headerlink" title="具体的垃圾收集器"></a>具体的垃圾收集器</h3><img src="image-20210324233901970.png" srcset="/img/loading.gif" lazyload alt="垃圾收集器概览" style="zoom:50%"><table><thead><tr><th></th><th>serial</th><th>ParNew</th><th>Parallel Scavenge</th><th>serial Old</th><th>Parallel Old</th><th>CMS</th><th><del>垃圾一号</del>G1</th></tr></thead><tbody><tr><td>线程</td><td>单线程</td><td>多行程</td><td>多线程</td><td>单线程</td><td>多线程</td><td>仅初始标记单线程</td><td>仅初始标记单线程</td></tr><tr><td>并发</td><td>否</td><td>否</td><td>否</td><td>否</td><td>否</td><td>仅初始标记、重新标记不并发</td><td>仅并发标记并发</td></tr><tr><td>特点</td><td></td><td>并行版serial</td><td>追求更高吞吐量</td><td>老年代版serial</td><td>老年代版Parallel Scavenge</td><td>追求最短停顿时间</td><td>次时代垃圾收集器</td></tr></tbody></table><p>TIPS：</p><ul><li>并行（Parallel）指多条垃圾收集线程同时工作，但是还是需要暂停所有用户线程</li><li>并发（Concurrent）即垃圾收集线程与用户线程同时工作</li><li>吞吐量（Throughput）即 运行用户代码时间/（运行用户代码时间+垃圾收集时间）</li></ul></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/java/">java</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/jvm/">jvm</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/2021040393ff/"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">优化的swing文本框</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2021032284d5/"><span class="hidden-mobile">单自由度树莓派相机云台</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><script type="text/javascript">Fluid.utils.loadComments("#comments",(function(){var t=document.documentElement.getAttribute("data-user-color-scheme");t="dark"===t?"github-dark":"github-light",window.UtterancesThemeLight="github-light",window.UtterancesThemeDark="github-dark";var e=document.createElement("script");e.setAttribute("src","https://utteranc.es/client.js"),e.setAttribute("repo","Tars-knock/Tars-knock.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","utterances"),e.setAttribute("theme",t),e.setAttribute("crossorigin","anonymous"),document.getElementById("comments").appendChild(e)}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="X"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a><div><span id="timeDate">载入天数...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script defer src="/js/leancloud.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/js/local-search.js"></script><script>$("#local-search-input").on("click",(function(){searchFunc("/local-search.xml","local-search-input","local-search-result")})),$("#modalSearch").on("shown.bs.modal",(function(){$("#local-search-input").focus()}))</script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?000c8623e418a244bb21d401c84cbfc3";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="/js/boot.js"></script></body></html>